<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EGC Network - Gold Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #FFD700;
            --blue: #007AFF;
            --bg-dark: #0a0b10;
            --card-bg: #161b22;
            --text-main: #ffffff;
            --text-dim: #8b949e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        h1, h2, .font-orbitron { font-family: 'Orbitron', sans-serif; }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Sync Indicator */
        #sync-status {
            position: fixed; top: 10px; left: 10px;
            font-size: 10px; color: var(--gold);
            display: none; z-index: 1000;
        }

        /* Header */
        header {
            padding: 20px; text-align: center;
            background: linear-gradient(to bottom, rgba(0,122,255,0.1), transparent);
        }

        .balance-container { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .currency-name { color: var(--gold); }

        /* Main Content & Tabs */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Home / Mining View */
        .clicker-area {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; margin-top: 20px;
        }

        .coin-wrapper { position: relative; width: 220px; height: 220px; cursor: pointer; }
        .coin {
            width: 100%; height: 100%;
            background: radial-gradient(circle, var(--gold) 0%, #b8860b 100%);
            border-radius: 50%;
            border: 8px solid rgba(255, 215, 0, 0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            transition: transform 0.1s;
        }
        .coin:active { transform: scale(0.95); }

        .energy-bar-container {
            width: 80%; height: 12px; background: #333;
            border-radius: 6px; margin-top: 30px; overflow: hidden;
        }
        .energy-fill {
            height: 100%; background: linear-gradient(90deg, var(--blue), #00c6ff);
            width: 100%; transition: width 0.2s;
        }

        /* Floating Number */
        .floating-num {
            position: absolute; color: var(--gold); font-weight: bold;
            pointer-events: none; animation: floatUp 0.8s ease-out forwards;
            font-family: 'Orbitron';
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }

        /* Leaderboard Style */
        .rank-item {
            display: flex; align-items: center; padding: 12px;
            background: var(--card-bg); margin-bottom: 8px; border-radius: 12px;
        }
        .rank-num { width: 30px; font-weight: bold; color: var(--gold); }
        .rank-img { width: 35px; height: 35px; border-radius: 50%; margin: 0 10px; background: #333; }
        .rank-info { flex: 1; }
        .rank-score { font-weight: bold; color: var(--gold); }

        /* Navigation */
        nav {
            position: fixed; bottom: 0; width: 100%; max-width: 500px;
            background: rgba(22, 27, 34, 0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid #30363d; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-dim); font-size: 10px; text-decoration: none; cursor: pointer;
        }
        .nav-item.active { color: var(--blue); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        /* Shop Items */
        .shop-item {
            background: var(--card-bg); padding: 15px; border-radius: 12px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-buy {
            background: var(--blue); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-weight: bold;
        }
        .btn-buy:disabled { background: #333; }
    </style>
</head>
<body>

<div id="app">
    <div id="sync-status">Syncing...</div>

    <header>
        <div class="balance-container">
            <span id="balance">0</span> <span class="currency-name">EGC</span>
        </div>
        <div style="font-size: 12px; color: var(--text-dim);">Mining Bot: +<span id="pps">0</span>/sec</div>
    </header>

    <main>
        <section id="home" class="tab-content active">
            <div class="clicker-area">
                <div class="coin-wrapper" id="coin-btn">
                    <div class="coin">üìÄ</div>
                </div>
                <div class="energy-bar-container">
                    <div id="energy-fill" class="energy-fill"></div>
                </div>
                <p><span id="energy-text">1000</span> / 1000 Energy</p>
            </div>
        </section>

        <section id="rank" class="tab-content">
            <h2 class="font-orbitron">Leaderboard</h2>
            <div id="leaderboard-list">
                <p style="text-align: center;">Loading Top Players...</p>
            </div>
        </section>

        <section id="shop" class="tab-content">
            <h2 class="font-orbitron">Upgrades</h2>
            <div class="shop-item">
                <div>
                    <div><b>Mining Bot v1</b></div>
                    <div style="font-size: 12px; color: var(--text-dim);">+1 EGC per second</div>
                </div>
                <button class="btn-buy" onclick="buyUpgrade(100, 1)">100 EGC</button>
            </div>
            <div class="shop-item">
                <div>
                    <div><b>Turbo Drill</b></div>
                    <div style="font-size: 12px; color: var(--text-dim);">+5 EGC per second</div>
                </div>
                <button class="btn-buy" onclick="buyUpgrade(500, 5)">500 EGC</button>
            </div>
        </section>

        <section id="tasks" class="tab-content">
            <h2 class="font-orbitron">Tasks</h2>
            <div class="shop-item" onclick="window.open('https://t.me/EGC_Network')">
                <div>Join Community</div>
                <div style="color: var(--gold);">+1000 EGC</div>
            </div>
        </section>

        <section id="wallet" class="tab-content">
            <h2 class="font-orbitron">Wallet</h2>
            <p>Connect your TON wallet soon...</p>
            <div style="background: #1c2128; padding: 15px; border-radius: 12px; word-break: break-all;">
                <small>Referral Link:</small><br>
                <code id="ref-link" style="color: var(--blue);">Loading...</code>
            </div>
        </section>
    </main>

    <nav>
        <div class="nav-item active" onclick="showTab('home', this)"><span class="nav-icon">üè†</span>Home</div>
        <div class="nav-item" onclick="showTab('tasks', this)"><span class="nav-icon">üìã</span>Tasks</div>
        <div class="nav-item" onclick="showTab('shop', this)"><span class="nav-icon">‚ö°</span>Shop</div>
        <div class="nav-item" onclick="showTab('rank', this)"><span class="nav-icon">üèÜ</span>Rank</div>
        <div class="nav-item" onclick="showTab('wallet', this)"><span class="nav-icon">üí∞</span>Wallet</div>
    </nav>
</div>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Telegram WebApp Setup
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // User Data from Telegram
    const user = tg.initDataUnsafe.user || { id: 0, first_name: "Guest", username: "guest", photo_url: "" };
    const userId = user.id;

    // Game State
    let state = {
        balance: parseInt(localStorage.getItem('egc_balance')) || 0,
        energy: parseInt(localStorage.getItem('egc_energy')) || 1000,
        pps: parseInt(localStorage.getItem('egc_pps')) || 0,
        lastSync: Date.now()
    };

    // UI Updates
    function updateUI() {
        document.getElementById('balance').innerText = Math.floor(state.balance).toLocaleString();
        document.getElementById('energy-text').innerText = state.energy;
        document.getElementById('energy-fill').style.width = (state.energy / 10) + '%';
        document.getElementById('pps').innerText = state.pps;
        localStorage.setItem('egc_balance', state.balance);
        localStorage.setItem('egc_energy', state.energy);
        localStorage.setItem('egc_pps', state.pps);
    }

    // Tab Logic
    function showTab(tabId, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        el.classList.add('active');
        if(tabId === 'rank') fetchLeaderboard();
    }

    // Mining Logic
    const coinBtn = document.getElementById('coin-btn');
    coinBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (state.energy > 0) {
            state.balance += 1;
            state.energy -= 1;
            
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            const touch = e.touches[0];
            createFloatingNumber(touch.clientX, touch.clientY);
            updateUI();
        }
    });

    function createFloatingNumber(x, y) {
        const num = document.createElement('div');
        num.className = 'floating-num';
        num.innerText = '+1';
        num.style.left = x + 'px';
        num.style.top = y + 'px';
        document.body.appendChild(num);
        setTimeout(() => num.remove(), 800);
    }

    // Energy Regen & Passive Income
    setInterval(() => {
        if (state.energy < 1000) state.energy += 1;
        if (state.pps > 0) state.balance += (state.pps / 10);
        updateUI();
    }, 1000);

    // Shop Logic
    function buyUpgrade(cost, ppsGain) {
        if (state.balance >= cost) {
            state.balance -= cost;
            state.pps += ppsGain;
            updateUI();
            saveToFirebase();
        } else {
            tg.showAlert("Not enough EGC!");
        }
    }

    // Firebase Sync
    async function saveToFirebase() {
        document.getElementById('sync-status').style.display = 'block';
        try {
            await db.ref('users/' + userId).set({
                username: user.username || user.first_name,
                score: Math.floor(state.balance),
                photo_url: user.photo_url || "",
                pps: state.pps,
                lastUpdate: Date.now()
            });
        } catch (e) { console.error(e); }
        setTimeout(() => { document.getElementById('sync-status').style.display = 'none'; }, 1000);
    }

    function fetchLeaderboard() {
        db.ref('users').orderByChild('score').limitToLast(10).once('value', (snapshot) => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            let players = [];
            snapshot.forEach(child => { players.push(child.val()); });
            players.reverse().forEach((p, index) => {
                list.innerHTML += `
                    <div class="rank-item">
                        <div class="rank-num">#${index + 1}</div>
                        <img class="rank-img" src="${p.photo_url || 'https://via.placeholder.com/35'}">
                        <div class="rank-info"><b>${p.username}</b></div>
                        <div class="rank-score">${p.score.toLocaleString()}</div>
                    </div>
                `;
            });
        });
    }

    // Init App
    window.onload = () => {
        tg.showConfirm("Welcome to EGC Network! Start mining?", (confirmed) => {
            if (!confirmed) tg.close();
        });

        document.getElementById('ref-link').innerText = `https://t.me/Gold_Cliker_Nova_Bot/app?startapp=ref_${userId}`;

        // Initial Fetch from Firebase (Source of Truth)
        db.ref('users/' + userId).once('value', (snap) => {
            const val = snap.val();
            if (val) {
                state.balance = val.score;
                state.pps = val.pps || 0;
                updateUI();
            }
        });

        // Periodic Sync
        setInterval(saveToFirebase, 10000);
    };

    // Save on Close
    tg.onEvent('viewportChanged', saveToFirebase);
</script>

</body>
</html>

